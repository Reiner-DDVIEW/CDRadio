<html>
<<<<<<< HEAD
	<head>
		<title>{{ title }}</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
        <script>
            $(document).ready(function(){
                loadPlaylist();
                checkUploadingAccess();
                $('#UploadForm > form > button').click(function() {
                    var fd = $("input[type='file']").prop("files")[0];
                    var form_data = new FormData();
                    form_data.append('file', fd);
                    $('#UploadForm > form > button').prop('disabled',true);
                    $('input[type="file"]').prop('disabled',true);
                    $.ajax({
                        xhr: function(){
                            var xhr = new window.XMLHttpRequest();
                            xhr.upload.addEventListener("progress", function(evt){
                                if (evt.lengthComputable) {
                                    var percentComplete = Math.round((evt.loaded/evt.total)*100);
                                    $("#UploadForm > form > progress").show();
                                    $("#UploadForm > form > progress")[0].value = percentComplete;
                                }
                            }, false);
                            return xhr;
                        },
                        url: '/upload',
                        type: 'POST',
                        dataType: 'text',
                        cache: false,
                        contentType: false,
                        processData: false,
                        data: form_data,
                        success: function(response){
                                var alert_data = $.parseJSON(response);
                                if (alert_data.upload == false){
                                    alert(alert_data.reason);
                                    }
                                else {$("#UploadForm > form")[0].reset()};
                                },
                        error: function(response,xhr,status,e){
                            var alert_data = $.parseJSON(response);
                            if (alert_data.upload == false){
                                alert(alert_data.reason)
                                }
                            else {alert(e)};
                            },
                        complete: function(){
                            $('#UploadForm > form > button').prop('disabled',false);
                            $('input[type="file"]').prop('disabled',false);
                            $("#UploadForm > form > progress").hide();
                            $("#UploadForm > form > progress")[0].value = "0";
                            checkUploadingAccess();
                        }
                    });
                });
               
                $('#YoutubeForm > form > button').click(function() {
                    $('#YoutubeForm > form > button').prop('disabled',true);
                    $('#YoutubeForm > form')[0].link.disabled=true;
                    var form_data = JSON.stringify({
                        link: $('#YoutubeForm > form')[0].link.value
                    });
                    $.ajax({
                        xhr: function(){
                            var xhr = new window.XMLHttpRequest();
                            xhr.upload.addEventListener("progress", function(evt){
                                if (evt.lengthComputable) {
                                    var percentComplete = Math.round((evt.loaded/evt.total)*100);
                                    $("#YoutubeForm > form > progress").show();
                                    $("#YoutubeForm > form > progress")[0].value = percentComplete;
                                }
                            }, false);
                            return xhr;
                        },
                        url: '/youtube',
                        type: 'POST',
                        dataType: 'text',
                        cache: false,
                        contentType: false,
                        processData: false,
                        data: form_data,
                        success: function(response){
                                var alert_data = $.parseJSON(response);
                                if (alert_data.upload == false){
                                    alert(alert_data.reason);
                                    }
                                else {$("#YoutubeForm > form")[0].reset()};
                                },
                        error: function(response,xhr,status,e){
                            var alert_data = $.parseJSON(response);
                            if (alert_data.upload == false){
                                alert(alert_data.reason)
                                }
                            else {alert(e)};
                            },
                        complete: function(){
                            $('#YoutubeForm > form > button').prop('disabled',false);
                            $('#YoutubeForm > form')[0].link.disabled=false;
                            $("#YoutubeForm > form > progress").hide();
                            $("#YoutubeForm > form > progress")[0].value = "0";
                            checkUploadingAccess();
                        }
                    });
                });
                $('#ToggleForm')[0].reset();
                $('#ToggleForm').change(function(event) {
                    switch(event.target.value){
                        case 'youtube':
                        $('#UploadForm').hide();
                        $('#YoutubeForm').show();
                        break;
                        default:
                        $('#UploadForm').show();
                        $('#YoutubeForm').hide();
                    }
                });
            });
           
            function loadPlaylist() {
              $.get('/playlist', function (data, status) {
                $('#Playlist').children().remove();
                var len = data.length;
                while (len--) {
                  $('<li>', {
                    text: data[len]
                  }).appendTo('#Playlist');
                }
                $('#Playlist > li').after('<hr/>');
                setTimeout(loadPlaylist, 15000);
              });
            }
 
            function checkUploadingAccess(){
                var access = true;
                var checking = function(){
                    $.get('http://maihomu.ddns.net:5000/allowed', function (data, status) {
                        if (data.upload_allowed == access){
                            if(access){
                                return;
                            } else{
                                setTimeout(checking, 10000);
                            }
                        }
                        else{
                            if(access){
                                $('#UploadForm > form > button').prop('disabled',true);
                                $('#YoutubeForm > form > button').prop('disabled',true);
                                access = !access;
                                setTimeout(checking, 10000);
                            } else{
                                $('#UploadForm > form > button').prop('disabled',false);
                                $('#YoutubeForm > form > button').prop('disabled',false);
                            }
                        }
                    });
                };
                checking();
            }
           
        </script>
=======
>>>>>>> pr/1

<head>
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div id="TopHead">
        {{ title }}
    </div>

    <div id="LowerHead">
        {{ remark }}
    </div>

    <div id="ExtOpen">
        <a href="{{ ext_link }}">Open in external player.</a>
    </div>

    <div id="Player">
        <audio controls preload="none">
            <source src="{{ stream_source }}" type="audio/ogg"> Your browser does not support the audio element, sucks to be you.
        </audio>
    </div>

    <div id="Playlist"></div>
    <div>
        <form id="ToggleForm">
            <fieldset>
                <input type="radio" name="form" value="file" checked>
                <label for="file">Files</label>
                <input type="radio" name="form" value="youtube">
                <label for="youtube">Youtube</label>
                <p id="UploadWarning">You are currently unable to upload.</p>
            </fieldset>
        </form>
    </div>
    <div id="UploadForm">
        <form action="/upload" method="POST" enctype="multipart/form-data">
            <input type="file" name="file" />
            <button type="button">Submit</button>
            <br>
            <progress max="100" style="display: none;" value="0"></progress>
        </form>
    </div>
    <div id="YoutubeForm" style="display: none;">
        <form>
            <input name="link" type="text">
            <button type="button">Submit</button>
            <br>
            <progress max="100" style="display: none;" value="0"></progress>
        </form>
    </div>

</body>

</html>