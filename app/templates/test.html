<html>
    <head>
        <title>{{ title }}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        
        <script>
            $(document).ready(function () {
                //Resetting the UI from cached values and fetching the current upload-rights
                $('#ToggleForm')[0].reset();
                $('#UploadForm > form')[0].reset();
                $('#YoutubeForm > form')[0].reset();
                checkUploadingAccess();
    
                //Starting the playlist loop
                loadPlaylist();
    
                $('#UploadForm > form > button').click(function () {
                    var fd = $("input[type='file']").prop("files")[0];
                    var form_data = new FormData();
                    form_data.append('file', fd);
                    $('#UploadForm > form > button').prop('disabled', true);
                    $('input[type="file"]').prop('disabled', true);
                    $.ajax({
                        xhr: function () {
                            var xhr = new window.XMLHttpRequest();
                            xhr.upload.addEventListener("progress", function (evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = Math.round((evt.loaded / evt.total) * 100);
                                    $("#UploadForm > form > progress").show();
                                    $("#UploadForm > form > progress")[0].value = percentComplete;
                                }
                            }, false);
                            return xhr;
                        },
                        url: '/upload',
                        type: 'POST',
                        dataType: 'text',
                        cache: false,
                        contentType: false,
                        processData: false,
                        data: form_data,
                        success: function (response) {
                            var alert_data = $.parseJSON(response);
                            if (alert_data.upload == false) {
                                alert(alert_data.reason);
                            } else {
                                $("#UploadForm > form")[0].reset()
                            };
                        },
                        error: function (response, xhr, status, e) {
                            alert('Upload error: ' + status);
                        },
                        complete: function () {
                            $('#UploadForm > form > button').prop('disabled', false);
                            $('input[type="file"]').prop('disabled', false);
                            $("#UploadForm > form > progress").hide();
                            $("#UploadForm > form > progress")[0].value = "0";
                            checkUploadingAccess();
                        }
                    });
                });
    
                $('#YoutubeForm > form > button').click(function () {
                    $('#YoutubeForm > form > button').prop('disabled', true);
                    $('#YoutubeForm > form')[0].link.disabled = true;
                    var form_data = JSON.stringify({
                        link: $('#YoutubeForm > form')[0].link.value
                    });
                    $.ajax({
                        xhr: function () {
                            var xhr = new window.XMLHttpRequest();
                            xhr.upload.addEventListener("progress", function (evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = Math.round((evt.loaded / evt.total) * 100);
                                    $("#YoutubeForm > form > progress").show();
                                    $("#YoutubeForm > form > progress")[0].value = percentComplete;
                                }
                            }, false);
                            return xhr;
                        },
                        url: '/youtube',
                        type: 'POST',
                        dataType: 'text',
                        cache: false,
                        contentType: false,
                        processData: false,
                        data: form_data,
                        success: function (response) {
                            var alert_data = $.parseJSON(response);
                            if (alert_data.upload == false) {
                                alert(alert_data.reason);
                            } else {
                                $("#YoutubeForm > form")[0].reset()
                            };
                        },
                        error: function (response, xhr, status, e) {
                            alert('Upload error: ' + status);
                        },
                        complete: function () {
                            $('#YoutubeForm > form > button').prop('disabled', false);
                            $('#YoutubeForm > form')[0].link.disabled = false;
                            $("#YoutubeForm > form > progress").hide();
                            $("#YoutubeForm > form > progress")[0].value = "0";
                            checkUploadingAccess();
                        }
                    });
                });
    
                $('#ToggleForm').change(function (event) {
                    switch (event.target.value) {
                        case 'youtube':
                            $('#UploadForm').hide();
                            $('#YoutubeForm').show();
                            break;
                        default:
                            $('#UploadForm').show();
                            $('#YoutubeForm').hide();
                    }
                });
            });
    
            function loadPlaylist() {
                $.get('/playlist', function (data, status) {
                    $('#Playlist').children().remove();
                    var len = data.length;
                    while (len--) {
                        $('<li>', {
                            text: data[len]
                        }).appendTo('#Playlist');
                    }
                    $('#Playlist > li').after('<hr/>');
                    setTimeout(loadPlaylist, 15000);
                });
            }
    
            function checkUploadingAccess() {
                var access = true;
                var checking = function () {
                    $.get('/allowed', function (data, status) {
                        if (data.upload_allowed == access) {
                            if (access) {
                                return;
                            } else {
                                setTimeout(checking, 10000);
                            }
                        } else {
                            if (access) {
                                $('#UploadForm > form > button').prop('disabled', true);
                                $('#YoutubeForm > form > button').prop('disabled', true);
                                $('#UploadWarning').css("visibility", "visible");
                                access = !access;
                                setTimeout(checking, 10000);
                            } else {
                                $('#UploadForm > form > button').prop('disabled', false);
                                $('#YoutubeForm > form > button').prop('disabled', false);
                                $('#UploadWarning').css("visibility", "hidden");
                            }
                        }
                    });
                };
                checking();
            }
        </script>
    
    
        <style>
            body {
                background-color: black;
                position: absolute;
                margin: 0;
                width: 100%;
                height: 100vh;
            }
            div {
                display: block;
                margin: 0 auto;
                padding: 0 1vw;
                width: 30%;
                min-width: 500px;
                color: white;
                background-color:grey;
            }
            #TopHead {
                text-align: center;
                font-size: 28px;
                font-weight: bold;
                height: 34px;
            }
            #LowerHead {
                text-align: center;
                height: 18px;
            }
            #ExtOpen {
                text-align: center;
                font-size: 10px;
            }
            #Player {
                height: 40px;
                padding-top: 1vh;
                padding-bottom: 1vh;
            }
            audio {
                width: 100%;
            }
            #Playlist {
                height: calc(90vh - 144px);
                overflow-y: scroll;
            }
            #UploadForm {
                height: 40px;
                padding-top: 1vh;
                padding-bottom: 1vh;
            }
            #UploadWarning {
                display: inline;
                color: red;
                visibility: hidden;
            }
            #YoutubeForm {
                height: 40px;
                padding-top: 1vh;
                padding-bottom: 1vh;
            }
            form {
                margin: 0;
            }
            input[type='file'] {
                width: 80%;
            }
            input[type='text'] {
                width: 80%;
            }
            button {
                width: calc(20% - 4px);
            }
            progress {
                width: 99.6%;
            }
        </style>
        
    </head>

<body>
    <div id="TopHead">
    {{ title }}
    </div>
    
    <div id="LowerHead">
    {{ remark }}
    </div>
    
    <div id="ExtOpen">
    <a href="{{ ext_link }}">Open in external player.</a>
    </div>
    
    <div id="Player">
        <audio controls preload="none">
            <source src="{{ stream_source }}" type="audio/ogg">
            Your browser does not support the audio element, sucks to be you.
        </audio> 
    </div>
    
    <div id="Playlist"></div>
    <div>
        <form id="ToggleForm">
            <fieldset>
                <input type="radio" name="form" value="file" checked>
                <label for="file">Files</label>
                <input type="radio" name="form" value="youtube">
                <label for="youtube">Youtube</label>
                <p id="UploadWarning">You are currently unable to upload.</p>
            </fieldset>
        </form>
    </div>
    <div id="UploadForm">
        <form action="/upload" method="POST" enctype="multipart/form-data">
            <input type="file" name="file" />
            <button type="button">Submit</button>
            <br>
            <progress max="100" style="display: none;" value="0"></progress>
        </form>
    </div>
    <div id="YoutubeForm" style="display: none;">
        <form>
            <input name="link" type="text">
            <button type="button">Submit</button>
            <br>
            <progress max="100" style="display: none;" value="0"></progress>
        </form>
    </div>

</body>

</html>
